<div align="center">
  <img src="icon.ico" alt="NekoShark Logo" width="200"/>
  <h1>NekoShark 🐱🦈</h1>
  <p>基于 PyQt6 开发的现代化网络流量分析工具</p>
  <p>提供实时数据包捕获、深度解析、灵活过滤和可视化统计功能</p>
</div>

---

## ✨ 核心功能

### 📡 实时数据包捕获
- 智能网络接口选择（自动识别活动网卡，支持手动选择）
- 使用 Scapy 异步嗅探器捕获网络流量
- 支持 BPF 过滤器（如 `tcp port 80`、`host 192.168.1.1`）
- 支持正则表达式显示过滤器，灵活筛选已捕获的数据包
- 网络状态实时监控（正常/可能断网）
- 自动检测网络中断并记录警告

### 🔍 深度数据包解析
- **数据链路层**：以太网帧（MAC 地址、EtherType）
- **网络层**：IPv4、IPv6、ARP
- **传输层**：TCP、UDP、ICMP
- **应用层**：DNS 查询/响应解析
- 树形结构展示各层详细字段信息

### 🎯 智能过滤系统
- **BPF 过滤器**：捕获时过滤，减少资源占用
- **正则表达式过滤器**：捕获后过滤，支持复杂模式匹配
  - 示例：`192\.168\..*` - 筛选局域网流量
  - 示例：`DNS|ARP` - 显示 DNS 或 ARP 包
  - 示例：`tcp.*80` - 包含 tcp 和 80 的包
- 实时语法验证和错误提示

### 📊 可视化统计分析
- **协议统计表**：动态显示所有协议的数据包计数（按数量排序）
- **IPv6 趋势图**：24 小时 IPv6 流量占比变化
- **协议分布图**：TCP/UDP/ARP 数据包数量对比
- **资源监控**：CPU 和内存使用情况实时监测

### 💾 数据持久化
- **轮转式 JSONL 存储**：单文件超过 50MB 自动创建新文件
- **多文件管理**：自动遍历所有轮转文件进行读取
- **增量式写入**：实时保存，防止数据丢失
- **导入/导出**：保存和加载捕获会话
- **分页浏览**：高效处理大规模数据包（可配置每页数量）
- **智能缓存**：可配置内存缓存大小（100-50000 个数据包）

#### PCAP 导入导出功能

- **导入 PCAP 文件**：点击"📥 导入 PCAP"按钮,可以加载由 Wireshark、tcpdump 等工具生成的标准 PCAP 文件。导入后的数据包会被完整解析,保留原始时间戳和字节流,可以像捕获的数据包一样进行查看、过滤和分析。
- **导出为 PCAP**：点击"📤 导出 PCAP"按钮,可以将当前会话的数据包导出为标准 PCAP 格式,兼容 Wireshark、tcpdump 等工具。导出时会优先使用原始字节(如果保存了原始包),否则基于解析字段重构数据包。
- **保存原始包 (Save raw packets)**：在设置中可以启用"保存原始包"选项。启用后,捕获到的每个数据包会同时保存其原始字节流(Base64 编码)和精确时间戳,确保导出 PCAP 时能完整还原原始流量。
- **存储影响**：保存原始字节会显著增加存储需求(视网络流量和包大小而定)。建议在需要精确回放或与其他工具互操作时启用；长时间运行或高吞吐场景下可保持关闭以节省磁盘空间。
- **使用场景**：
  - 📥 导入 Wireshark 抓包文件进行二次分析
  - 📤 导出捕获结果供 Wireshark 深度分析
  - 🔄 在不同抓包工具间转换和共享数据

### ⚙️ 高级设置
- **明色/暗色主题**：护眼的暗色主题，默认启用
- **性能调优**：
  - 批处理大小（10-1000）
  - 缓存大小（100-50000）
- **自动功能**：
  - 自动滚动到底部
  - 自动跳转到最新页
- 设置持久化保存

## 🖥️ 系统要求

- **操作系统**：Windows / Linux / macOS
- **Python**：3.9 或更高版本
- **权限**：需要管理员/root 权限进行数据包捕获

## 📦 安装依赖

```bash
pip install -r requirements.txt
```

### 依赖列表
- `PyQt6>=6.6.0` - 现代化 GUI 框架
- `scapy>=2.5` - 数据包捕获和解析
- `matplotlib>=3.7` - 数据可视化
- `psutil>=5.9` - 系统资源监控

## 🚀 快速开始

### Windows

```bash
# 以管理员身份运行 PowerShell
python run.py
```

### Linux

```bash
sudo python3 run.py
```

### macOS

```bash
sudo python3 run.py
```

## 📖 使用指南

### 基本操作

1. **启动捕获**
   - 选择网络接口（默认自动选择活动网卡）
   - （可选）输入 BPF 过滤器，如 `tcp port 443`
   - 点击 "▶ 开始捕获" 按钮
   - 观察网络状态指示器（● 正常 / ● 可能断网）

2. **查看数据包**
   - 左侧列表显示实时捕获的数据包
   - 点击任一数据包查看详细解析信息
   - 使用分页控件浏览历史数据

3. **应用过滤器**
   - 在 "显示过滤器" 输入正则表达式
   - 实时过滤显示结果
   - 绿色 ✓ 表示语法正确，红色 ✖ 表示错误

4. **查看统计**
   - 切换到 "📊 统计信息" 标签页
   - 查看协议分布和趋势图表

5. **保存/加载**
   - 点击 "💾 保存捕获" 导出为 JSON 文件
   - 点击 "📂 加载捕获" 导入历史数据
   - 点击 "📥 导入 PCAP" 从 PCAP 文件导入数据包
   - 点击 "📤 导出 PCAP" 导出为 PCAP 格式(可用 Wireshark 打开)

### 高级功能

#### 自定义设置
点击 "⚙️ 设置" 打开配置对话框：
- **界面主题**：切换明色/暗色主题
- **性能设置**：调整批处理大小（影响响应速度）
- **缓存设置**：调整内存缓存大小（影响内存占用）
- **自动功能**：启用/禁用自动滚动和自动换页

#### 正则表达式示例
- `192\.168\.1\..*` - 匹配 192.168.1.x 网段
- `(TCP|UDP)` - 显示 TCP 或 UDP 包
- `google|cloudflare` - 包含特定关键字
- `port.*443` - 包含 443 端口的包

#### 分页导航
- **每页记录**：可调整每页显示的数据包数量
- **◀ / ▶**：上一页/下一页
- **加载页面**：跳转到最新页
- **新数据提示**：显示未查看的新数据包数量

## 🔧 长时间运行建议

本工具设计用于长时间运行（1天或更长），已实施以下优化：

### 内存管理

- ✅ 资源监控样本自动限制在最近 200 条
- ✅ 内存缓存可配置上限（默认 5000 个数据包）
- ✅ 超出缓存的数据自动写入轮转 JSONL 文件
- ✅ 统计数据自动清理超过 24 小时的记录

### 性能优化

- ✅ 批处理机制减少 UI 更新频率
- ✅ 分页加载避免一次性渲染大量数据
- ✅ 后台线程处理数据包解析
- ✅ 图表更新频率智能控制

### 稳定性保障

- ✅ 网络状态监控（每 30 秒检查）
- ✅ 超过 60 秒未收到包自动警告
- ✅ 异常处理防止崩溃
- ✅ 轮转式 JSONL 文件实时刷新防止数据丢失

### 最佳实践

1. **调整批处理大小**：网络流量大时增大批处理，提高性能
2. **限制缓存大小**：内存有限时减小缓存，避免 OOM
3. **使用 BPF 过滤器**：只捕获需要的流量，减少存储和处理开销
4. **定期保存数据**：长时间运行后手动保存，避免意外丢失
5. **监控资源占用**：在 "💻 资源监控" 标签查看 CPU 和内存使用
6. **轮转文件管理**：捕获目录中会生成多个 JSONL 文件（每个最大 50MB），结束后可手动清理旧文件

## 📁 项目结构

```
packet_capture_tool-main/
├── packet_capture_tool/      # 核心代码
│   ├── app.py                # PyQt6 主应用
│   ├── capture.py            # 数据包捕获管理
│   ├── packet_parser.py      # 数据包解析
│   ├── stats.py              # 统计分析
│   ├── storage.py            # 轮转式数据持久化
│   └── resource_monitor.py   # 资源监控
├── captures/                 # 捕获数据存储目录（自动创建轮转文件）
│   ├── capture_YYYYmmdd_HHMMSS_0001.jsonl
│   ├── capture_YYYYmmdd_HHMMSS_0002.jsonl
│   └── ...
├── run.py                    # 启动脚本
├── requirements.txt          # 依赖清单
└── README.md                 # 本文档
```

## 🐛 故障排除

### Windows 上无法捕获数据包
- 确保以管理员身份运行
- 检查是否安装了 Npcap 或 WinPcap
- 尝试禁用防火墙或杀毒软件

### Linux 上权限错误
```bash
# 方法 1：使用 sudo
sudo python3 run_qt.py

# 方法 2：赋予 Python 捕获权限（推荐）
sudo setcap cap_net_raw,cap_net_admin=eip $(which python3)
```

### 没有捕获到 ARP 包

- 检查网卡是否在混杂模式下工作
- 在另一终端执行 `arp -d *` 清空缓存，然后 `ping` 网关
- 检查是否使用了过于严格的 BPF 过滤器

### 界面卡顿或无响应

- 在设置中减小批处理大小
- 减小缓存大小
- 使用更严格的 BPF 过滤器减少捕获量
- 关闭不必要的图表刷新

## 📝 开发说明

本项目使用 PyQt6 构建，所有核心功能都在 `src/` 目录下。修改代码后直接运行 `run.py` 即可看到效果。

## 📄 许可证

本项目仅供学习和研究使用。

## 🙏 致谢

- [Scapy](https://scapy.net) - 强大的数据包处理库
- [PyQt6](https://www.riverbankcomputing.com/software/pyqt/) - 优秀的 GUI 框架
- [Matplotlib](https://matplotlib.org/) - 数据可视化
- [psutil](https://github.com/giampaolo/psutil) - 系统监控
